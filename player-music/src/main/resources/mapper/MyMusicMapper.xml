<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.player.music.mapper.MyMusicMapper">

    <sql id="musicSql">
      select
      id,
      album_id,
      song_name,
      author_name,
      album_name,
      version,
      `language`,
      publish_date,
      wide_audio_id,
      is_publish,
      big_pack_id,
      final_id,
      audio_id,
      author_id,
      similar_audio_id,
      is_hot,
      album_audio_id,
      audio_group_id,
      cover,
      play_url,
      local_play_url,
      source_name,
      source_url,
      create_time,
      update_time,
      label,
      lyrics
      from music
    </sql>

    <select id="getKeywordMusic" resultType="MyMusicEntity">
        <include refid="musicSql"></include>
         order by is_hot desc limit 0,1
    </select>

    <select id="getMusicClassify" resultType="MusicClassifyEntity">
        select * from music_classify_relation where disabled = 0 and permission >= 0 order by classify_rank desc
    </select>

    <select id="getMusicListByClassifyId" resultType="MyMusicEntity">
        select m.*,(case when d.audio_id is not null then 1 else 0 end) as is_like from music_classify c left join music m on c.audio_id = m.audio_id left join music_directory d on c.audio_id = d.audio_id and d.user_id=#{userId} where c.classify_id =#{classifyId} order by c.audio_rank desc limit #{start},#{pageSize}
    </select>

    <select id="getMusicTotalByClassifyId" resultType="Long">
        select count(*) as total from music_classify where classify_id = #{classifyId}
    </select>

    <select id="getSingerList" resultType="MusicAuthorEntity">
        select * from music_authors where avatar is not null order by `rank` desc limit  #{start},#{pageSize}
    </select>

    <select id="getSingerTotal" resultType="Long">
        select count(*) as total from music_authors where avatar is not null
    </select>


    <select id="getMusiPlayMenu" resultType="MyMusiPlayMenuEntity">
        select t2.*,t1.total from
	        (select count(id) as total ,menu_id from music_play_list where menu_id in (SELECT id from music_play_menu where user_id = #{userId}) group by menu_id) t1
        LEFT JOIN music_play_menu t2 on t1.menu_id = t2.id
    </select>

    <select id="getMySinger" resultType="MySingerEntity">
        select t5.*,t4.author_name,t4.total,t4.avatar from
            (select t1.*,t2.author_name,t2.avatar from
                (
                    select count(audio_id) as total,author_id from music where author_id in
                    (select t3.author_id from
                        (select * from music_my_singer where user_id = #{userId} limit #{start},#{pageSize}) t3
                ) group by author_id) t1
            LEFT JOIN music_authors t2 on t1.author_id = t2.author_id) t4
        LEFT JOIN music_my_singer t5 on t4.author_id = t5.author_id
    </select>

    <select id="getMySingerCount" resultType="Long">
       SELECT count(*) as total FROM music_my_singer where user_id = #{userId}
    </select>
</mapper>

